# テストダブル

- [JUnit実践入門]([https://www.amazon.co.jp/JUnit%E5%AE%9F%E8%B7%B5%E5%85%A5%E9%96%80-%E4%BD%93%E7%B3%BB%E7%9A%84%E3%81%AB%E5%AD%A6%E3%81%B6%E3%83%A6%E3%83%8B%E3%83%83%E3%83%88%E3%83%86%E3%82%B9%E3%83%88%E3%81%AE%E6%8A%80%E6%B3%95-WEB-PRESS-plus/dp/477415377X](https://www.amazon.co.jp/JUnit実践入門-体系的に学ぶユニットテストの技法-WEB-PRESS-plus/dp/477415377X))の内容をまとめ

- テスト時に依存するオブジェクトがある場合、そのオブジェクトを「代役」で置き換える方法が有効。この代役となるオブジェクトはスタブやモックとして知られ、総称してテストダブル(test double)と呼ばれる
  - double は演劇や映画の代役、影武者の意味



## スタブ

- 依存オブジェクトに予測可能な振る舞いをさせる。

おもに次のような場合に使用される。

- 依存オブジェクトが予測出来ない振る舞いをする
- 依存オブジェクトのクラスがまだ存在しない
- 依存オブジェクトの実行コストが高く、簡単に利用できない
- 依存オブジェクトが実行環境に強く依存している



## モック

- モックは依存クラスやモジュールが正しく利用されているかを検証する目的で使われる



## スタブとモックの違い

- **スタブ**は仮の実装で予測可能な値を返すことで、予測が難しいテストケースを検証可能なテストケースとする。一方**モック**は目的のメソッドがテストの実行中に呼び出されたかを検証することが主な目的



## スパイ

- 依存オブジェクトの呼び出しを監視するのにつかわれる
  - ログの検証等で使用



- [【Java】Mockitoの飲み方（入門）](https://orizuru.io/blog/java/mockito-primer/)に記載の図が分かりやすいので掲載しておきます。

![test double](https://orizuru.io/wp/wp-content/uploads/2019/07/%E3%83%86%E3%82%B9%E3%83%88%E3%82%84%E3%83%86%E3%82%B9%E3%83%88%E5%AF%BE%E8%B1%A1%E3%81%8B%E3%82%89%E3%81%AE%E3%83%A2%E3%83%83%E3%82%AF%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E6%93%8D%E4%BD%9C-1.png)

## Mochitoのサンプル

- モックやスタブを簡単に実装できるMochitoのサンプルを上記書籍をベースに実装してみた

- まずはpomに記載

```xml
<!-- https://mvnrepository.com/artifact/org.mockito/mockito-all -->
<dependency>
    <groupId>org.mockito</groupId>
    <artifactId>mockito-all</artifactId>
    <version>1.10.19</version>
    <scope>test</scope>
</dependency>
```

- 以下がコード

```java
import static org.hamcrest.CoreMatchers.*;
import static org.junit.Assert.*;
import static org.mockito.Mockito.*;

import java.util.LinkedList;
import java.util.List;

import org.junit.Test;

public class MockTest {

	@Test
	public void mockTest() {
		//mockメソッドで生成されたオブジェクトはすべてのメソッドがnullを返す
		//スタブメソッドとして設定される
		List<String> mock = mock(List.class);
		assertThat(mock.get(0),is(nullValue()));
		assertThat(mock.contains("Hello"),is(false));
	}

	@Test
	public void stubTest() {
		List<String> stub = mock(List.class);
		when(stub.get(0)).thenReturn("Hello");
		assertThat(stub.get(0),is("Hello"));
	}

	@Test
	public void spyTest() {
		List<String> list = new LinkedList<String>();
		List<String> spy = spy(list);
		doReturn("Mochito").when(spy).get(1);
		spy.add("Hello");
		spy.add("World");
		verify(spy).add("Hello");
		verify(spy).add("World");
		assertThat(spy.get(0),is("Hello"));
		assertThat(spy.get(1),is("Mochito"));
		//こう書くと実際のメソッドが呼ばれる
		when(spy.get(1)).thenCallRealMethod();
		assertThat(spy.get(1),is("World"));
	}
}
```

